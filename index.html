<script src="jquery.min.js"></script>
<script>
  function compute() {
    // init ajax loading messages
    $("#msg1").html("Getting users' contests: <span id=\"contests\">0</span>%");
    $("#msg2").html("Getting contests' scores: <span id=\"scores\">0</span>%");
    $("#result").html("");
    
    // compute start time
    start = new Date($("#year").val(), $("#month").val()-1, $("#day").val(), 0, 0, 0, 0).getTime()/1000;
    
    // init handles
    handles = {};
    var tmp = $("#handles").val().split("\n");
    for (var i = 0; i < tmp.length; i++) {
      tmp[i] = tmp[i].trim();
      if (tmp[i].length == 0) continue;
      handles[tmp[i]] = "handle";
    }
    var tmp = [];
    for (var handle in handles) if (handles[handle] == "handle") {
      tmp.push(handle);
    }
    handles = tmp;
    
    // init contests
    contests = {};
    
    call_student(0);
  }
  
  function call_contest(i) {
    // stop recursion
    if (i >= contests.length) {
      // update view
      var result = [];
      for (var handle in students) if ("score" in students[handle]) {
        var tmp = {};
        tmp.handle = handle;
        tmp.n = students[handle].n;
        tmp.score = Math.round(students[handle].score/tmp.n);
        tmp.grade = tmp.score/100;
        if (tmp.n < 3 || tmp.grade < 0.1) tmp.grade = "SR";
        else if (tmp.grade < 3) tmp.grade = "II";
        else if (tmp.grade < 5) tmp.grade = "MI";
        else if (tmp.grade < 7) tmp.grade = "MM";
        else if (tmp.grade < 9) tmp.grade = "MS";
        else                    tmp.grade = "SS";
        result.push(tmp);
      }
      result.sort(function(a,b) {
        if (a.grade != "SR" && b.grade == "SR") return -1;
        if (a.grade == "SR" && b.grade != "SR") return  1;
        if (a.score != b.score) return b.score - a.score;
        if (a.n != b.n) return b.n - a.n;
        return Math.random()-0.5;
      });
      $("#result").html("");
      $("#result").append($("<tr><th>Handle</th><th>Contests</th><th>Score</th><th>Grade</th></tr>"));
      for (var j = 0; j < result.length; j++) {
        $("#result").append($("<tr><td>"+result[j].handle+"</td><td>"+result[j].n+"</td><td>"+result[j].score+"</td><td>"+result[j].grade+"</td></tr>"));
      }
      $("#scores").html("100");
      return;
    }
    
    // call Codeforces method
    $.ajax({
      crossDomain: true,
      url: "https://codeforces.com/api/contest.standings?contestId="+contests[i]+"&handles="+handles,
      success: function(response) {
        // call again for this contest
        if (response.status == "FAILED") {
          call_contest(i);
          return;
        }
        
        // update view
        $("#scores").html(Math.round(100*(i+1)/contests.length));
        
        // compute scores
        for (var j = 0; j < response.result.rows.length; j++) {
          var score = 0;
          for (var k = 0; k < response.result.rows[j].problemResults.length; k++) {
            score += response.result.rows[j].problemResults[k].points;
          }
          var handle = response.result.rows[j].party.members[0].handle;
          students[handle].score += score;
          students[handle].n++;
        }
        
        call_contest(i+1);
      }
    });
  }
  
  function call_student(i) {
    // stop recursion
    if (i >= handles.length) {
      // update view
      $("#contests").html("100");
      
      // compute contest ids
      var tmp = [];
      for (var j in contests) if (contests[j] == "contest") tmp.push(j);
      contests = tmp;
      
      // compute handle list with semicolon and init students object
      tmp = "";
      students = {};
      if (handles.length > 0) {
        tmp += handles[0];
        students[handles[0]] = {score: 0, n: 0};
      }
      for (var j = 1; j < handles.length; j++) {
        tmp += ";"+handles[j];
        students[handles[j]] = {score: 0, n: 0};
      }
      handles = tmp;
      if (handles == "") return;
      
      call_contest(0);
      return;
    }
    
    // call Codeforces method
    $.ajax({
      crossDomain: true,
      url: "https://codeforces.com/api/user.rating?handle="+handles[i],
      success: function(response) {
        // call again for this student
        if (response.status == "FAILED") {
          call_student(i);
          return;
        }
        
        // update view
        $("#contests").html(Math.round(100*(i+1)/handles.length));
        
        // compute contests
        for (var j = 0; j < response.result.length; j++) {
          if (response.result[j].ratingUpdateTimeSeconds < start) continue;
          contests[response.result[j].contestId] = "contest";
        }
        
        // call for next student
        call_student(i+1);
      }
    })
  }
  
  $(document).ready(function() {
    $("button").click(compute);
  });
</script>
<div>
  <table>
    <tr><td>Year</td><td><input id="year" type="number" /></td></tr>
    <tr><td>Month</td><td><input id="month" type="number" /></td></tr>
    <tr><td>Day</td><td><input id="day" type="number" /></td></tr>
    <tr><td valign="top">Handles</td><td><textarea id="handles" rows="20" cols="20"></textarea></td><td valign="top">(one handle per line)</td></tr>
    <tr><td><button>Compute</button></td><td></tr>
  </table>
  <h1 id="msg1"></h1>
  <h1 id="msg2"></h1>
  <table id="result"></table>
</div>
<style>
  div {
    margin: 0 auto;
    width: 33%;
  }
  table#result {
    border-collapse: collapse;
    font-family: 'Courier New', Courier, mono;
  }
  table#result, table#result th, table#result td {
    border: 2px solid black;
    padding: 2px 20px;
    text-align: center;
  }
</style>
